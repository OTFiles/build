name: OCR Recognition

on:
  push:
    branches: [ main, master ]
    paths:
      - 'images/**'
  workflow_dispatch:
    inputs:
      process_all:
        description: 'Process all images'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write

jobs:
  ocr:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install pytesseract pillow requests

    - name: Create text directory
      run: mkdir -p texts

    - name: Process all images
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.process_all == 'true'
      run: |
        python3 << 'EOF'
import os
import base64
import requests

API_URL = "https://api.ocr.space/parse/image"
API_KEY = "${{ secrets.OCR_API_KEY }}"

for root, dirs, files in os.walk('images'):
    for file in files:
        if file.lower().endswith(('.jpg', '.jpeg', '.png', '.bmp')):
            filepath = os.path.join(root, file)
            print(f"Processing: {filepath}")
            
            with open(filepath, 'rb') as f:
                image_data = f.read()
            
            # Convert to base64
            base64_image = base64.b64encode(image_data).decode('utf-8')
            
            # Send to OCR API
            payload = {
                "base64Image": base64_image,
                "language": "chs",
                "isOverlayRequired": False,
                "scale": True,
                "detectOrientation": True,
                "OCREngine": 2
            }
            
            try:
                response = requests.post(
                    API_URL,
                    json=payload,
                    headers={"apikey": API_KEY}
                )
                
                if response.status_code == 200:
                    result = response.json()
                    text = result.get('ParsedText', '')
                    
                    # Save text
                    output_file = os.path.join('texts', os.path.splitext(file)[0] + '.txt')
                    with open(output_file, 'w', encoding='utf-8') as f:
                        f.write(text)
                    print(f"Saved: {output_file}")
                else:
                    print(f"Error: {response.status_code} - {response.text}")
            except Exception as e:
                print(f"Error processing {filepath}: {e}")
EOF

    - name: Commit changes
      run: |
        git config user.email "bot@example.com"
        git config user.name "bot"
        git add texts/*.txt || true
        git diff --staged --quiet || git commit -m "Auto OCR [skip ci]" || true
        git pull --rebase || true
        git push || true