name: OCR Image Recognition

on:
  push:
    branches: [ main, master ]
    paths:
      - 'images/**'

jobs:
  ocr-recognition:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget xz-utils python3

    - name: Create text directory
      run: mkdir -p texts

    - name: Get changed image files
      id: changed-files
      uses: tj-actions/changed-files@v41
      with:
        files: |
          images/**/*.jpg
          images/**/*.jpeg
          images/**/*.png
          images/**/*.webp
          images/**/*.bmp

    - name: Process changed images
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        for img_file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          if [ -f "$img_file" ]; then
            echo "Processing: $img_file"
            filename=$(basename "$img_file")
            name_without_ext="${filename%.*}"
            text_file="texts/$name_without_ext.txt"

            base64 -w 0 "$img_file" > /tmp/image_base64.txt

            python3 << 'PYTHON_EOF'
import json
with open('/tmp/image_base64.txt', 'r') as f:
    base64_data = f.read().strip()

request_data = {
    "base64": base64_data,
    "options": {
        "ocr.language": "models/config_chinese.txt",
        "tbpu.parser": "multi_para",
        "data.format": "text"
    }
}

with open('/tmp/request.json', 'w') as f:
    json.dump(request_data, f, ensure_ascii=False)
PYTHON_EOF

            echo "OCR processing skipped for testing"
            echo "Test file: $text_file"
            echo "Test: $(date)" > "$text_file"

            rm -f /tmp/image_base64.txt /tmp/request.json
          fi
        done

    - name: Commit and push text files
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        if ! ls texts/*.txt 1> /dev/null 2>&1; then
          echo "No text files found"
          exit 0
        fi

        git add texts/*.txt

        if git diff --staged --quiet; then
          echo "No changes to commit"
          exit 0
        fi

        git commit -m "Auto-generated OCR text from images [skip ci]"
        git pull --rebase
        git push