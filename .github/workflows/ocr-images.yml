name: OCR Image Recognition

on:
  push:
    branches: [ main, master ]
    paths:
      - 'images/**'
      - 'images/*.jpg'
      - 'images/*.jpeg'
      - 'images/*.png'
      - 'images/*.webp'
      - 'images/*.bmp'
  workflow_dispatch:
    inputs:
      process_all:
        description: 'Process all images in the images directory'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  IMAGE_DIR: './images'
  TEXT_DIR: './texts'
  UMI_OCR_PORT: 1224

permissions:
  contents: write

jobs:
  ocr-recognition:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Create text directory
      run: mkdir -p ${{ env.TEXT_DIR }}

    - name: Get changed image files
      id: changed-files
      uses: tj-actions/changed-files@v41
      with:
        files: |
          images/**/*.jpg
          images/**/*.jpeg
          images/**/*.png
          images/**/*.webp
          images/**/*.bmp
          images/*.jpg
          images/*.jpeg
          images/*.png
          images/*.webp
          images/*.bmp

    - name: Start Umi-OCR Docker container
      run: |
        docker run -d --name umi-ocr \
          -e HEADLESS=true \
          -p ${{ env.UMI_OCR_PORT }}:${{ env.UMI_OCR_PORT }} \
          hiroi-sora/umi-ocr-runtime:latest
        
        # Wait for Umi-OCR to start
        echo "Waiting for Umi-OCR to start..."
        for i in {1..30}; do
          if curl -s http://localhost:${{ env.UMI_OCR_PORT }}/api/ocr > /dev/null 2>&1; then
            echo "Umi-OCR is ready"
            break
          fi
          echo "Attempt $i: Umi-OCR not ready yet..."
          sleep 2
        done

    - name: Process changed images
      if: steps.changed-files.outputs.any_changed == 'true' && github.event_name != 'workflow_dispatch'
      run: |
        if [ -z "${{ steps.changed-files.outputs.all_changed_files }}" ]; then
          echo "No image files changed"
          exit 0
        fi
        
        for img_file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          if [ -f "$img_file" ]; then
            echo "Processing: $img_file"
            filename=$(basename "$img_file")
            name_without_ext="${filename%.*}"
            text_file="${{ env.TEXT_DIR }}/$name_without_ext.txt"
            
            # Convert image to base64
            base64_data=$(base64 -w 0 "$img_file")
            
            # Call Umi-OCR API
            response=$(curl -s -X POST http://localhost:${{ env.UMI_OCR_PORT }}/api/ocr \
              -H "Content-Type: application/json" \
              -d "{
                \"base64\": \"$base64_data\",
                \"options\": {
                  \"ocr.language\": \"models/config_chinese.txt\",
                  \"tbpu.parser\": \"multi_para\",
                  \"data.format\": \"text\"
                }
              }")
            
            # Extract text from response
            ocr_text=$(echo "$response" | python3 -c "import sys, json; print(json.load(sys.stdin).get('data', ''))")
            
            # Save to text file
            echo "$ocr_text" > "$text_file"
            echo "Saved: $text_file"
          fi
        done

    - name: Process all images (manual trigger)
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.process_all == 'true'
      run: |
        find ${{ env.IMAGE_DIR }} -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" -o -name "*.bmp" \) | while read img_file; do
          echo "Processing: $img_file"
          filename=$(basename "$img_file")
          name_without_ext="${filename%.*}"
          text_file="${{ env.TEXT_DIR }}/$name_without_ext.txt"
          
          # Convert image to base64
          base64_data=$(base64 -w 0 "$img_file")
          
          # Call Umi-OCR API
          response=$(curl -s -X POST http://localhost:${{ env.UMI_OCR_PORT }}/api/ocr \
            -H "Content-Type: application/json" \
            -d "{
              \"base64\": \"$base64_data\",
              \"options\": {
                \"ocr.language\": \"models/config_chinese.txt\",
                \"tbpu.parser\": \"multi_para\",
                \"data.format\": \"text\"
              }
            }")
          
          # Extract text from response
          ocr_text=$(echo "$response" | python3 -c "import sys, json; print(json.load(sys.stdin).get('data', ''))")
          
          # Save to text file
          echo "$ocr_text" > "$text_file"
          echo "Saved: $text_file"
        done

    - name: Stop Umi-OCR Docker container
      if: always()
      run: docker stop umi-ocr && docker rm umi-ocr

    - name: Upload text artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ocr-texts
        path: ${{ env.TEXT_DIR }}/*.txt
        retention-days: 7

    - name: Commit and push text files
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add ${{ env.TEXT_DIR }}/*.txt
        
        # Check if there are files to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        
        git commit -m "Auto-generated OCR text from images [skip ci]"
        git push