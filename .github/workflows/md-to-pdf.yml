name: Convert MD to PDF

on:
  push:
    branches: [ main, master ]
    paths: 
      - 'md/**'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  MD_DIR: './md'
  PDF_DIR: './pdf'

jobs:
  convert-markdown:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup full LaTeX environment
      run: |
        # 安装完整的 TeX Live 发行版（包含所有中文支持包）
        sudo apt-get update
        sudo apt-get install -y \
          texlive-full \
          pandoc \
          fonts-noto-cjk \
          fonts-wqy-microhei \
          fonts-wqy-zenhei

    - name: Create PDF directory
      run: mkdir -p ${{ env.PDF_DIR }}

    - name: Get changed Markdown files
      id: changed-files
      uses: tj-actions/changed-files@v41
      with:
        files: |
          md/**/*.md
          md/*.md

    - name: Show changed files
      run: |
        echo "Changed files: ${{ steps.changed-files.outputs.all_changed_files }}"

    - name: Convert changed Markdown files to PDF
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        # 检查是否有更改的文件
        if [ -z "${{ steps.changed-files.outputs.all_changed_files }}" ]; then
          echo "No markdown files changed"
          exit 0
        fi
        
        # 处理每个修改的 Markdown 文件
        for md_file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          if [ -f "$md_file" ]; then
            echo "Converting: $md_file"
            
            # 提取文件名（不含扩展名）
            filename=$(basename "$md_file" .md)
            
            # 生成 PDF 文件名
            pdf_file="${{ env.PDF_DIR }}/$filename.pdf"
            
            # 使用 Pandoc 转换，使用更简单的中文支持方式
            pandoc "$md_file" \
              -o "$pdf_file" \
              --pdf-engine=xelatex \
              -V mainfont="WenQuanYi Micro Hei" \
              -V sansfont="WenQuanYi Micro Hei" \
              -V monofont="WenQuanYi Micro Hei Mono" \
              -V geometry:margin=0.5in \
              -V geometry:paper=a4paper \
              -V colorlinks=true \
              -V linkcolor=blue \
              -V urlcolor=blue \
              -V toccolor=blue \
              --listings \
              --highlight-style tango \
              -M date="$(date +'%Y年%m月%d日')" \
              -M author="自动生成" \
              --toc \
              --toc-depth=3 \
              -N
            
            echo "Generated: $pdf_file"
          fi
        done

    - name: Convert all MD files (manual trigger)
      if: github.event_name == 'workflow_dispatch'
      run: |
        # 手动触发时转换所有文件
        find ${{ env.MD_DIR }} -name "*.md" | while read md_file; do
          echo "Converting: $md_file"
          filename=$(basename "$md_file" .md)
          pdf_file="${{ env.PDF_DIR }}/$filename.pdf"
          
          pandoc "$md_file" \
            -o "$pdf_file" \
            --pdf-engine=xelatex \
            -V mainfont="WenQuanYi Micro Hei" \
            -V sansfont="WenQuanYi Micro Hei" \
            -V monofont="WenQuanYi Micro Hei Mono" \
            -V geometry:margin=0.5in \
            -V geometry:paper=a4paper \
            -V colorlinks=true \
            -V linkcolor=blue \
            -V urlcolor=blue \
            -V toccolor=blue \
            --listings \
            --highlight-style tango \
            -M date="$(date +'%Y年%m月%d日')" \
            -M author="自动生成" \
            --toc \
            --toc-depth=3 \
            -N
        done

    - name: Upload PDF artifacts
      uses: actions/upload-artifact@v4
      with:
        name: generated-pdfs
        path: ${{ env.PDF_DIR }}/*.pdf
        retention-days: 7

    - name: Commit and push PDF files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add ${{ env.PDF_DIR }}/*.pdf
        git diff --staged --quiet || git commit -m "Auto-generated PDFs from Markdown [skip ci]"
        git push