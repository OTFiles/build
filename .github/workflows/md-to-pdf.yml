name: Convert MD to PDF

on:
  push:
    branches: [ main, master ]
    paths: 
      - 'md/**'
  workflow_dispatch:

env:
  MD_DIR: './md'
  PDF_DIR: './pdf'
  
# 添加写入权限
permissions:
  contents: write

jobs:
  convert-markdown:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # 重要：使用 personal access token 而不是默认的 GITHUB_TOKEN
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup full LaTeX environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          texlive-full \
          pandoc \
          fonts-noto-cjk \
          fonts-wqy-microhei \
          fonts-wqy-zenhei

    - name: Create PDF directory
      run: mkdir -p ${{ env.PDF_DIR }}

    - name: Get changed Markdown files
      id: changed-files
      uses: tj-actions/changed-files@v41
      with:
        files: |
          md/**/*.md
          md/*.md

    - name: Convert changed Markdown files to PDF
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        if [ -z "${{ steps.changed-files.outputs.all_changed_files }}" ]; then
          echo "No markdown files changed"
          exit 0
        fi

        for md_file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          if [ -f "$md_file" ]; then
            echo "Converting: $md_file"
            filename=$(basename "$md_file" .md)
            pdf_file="${{ env.PDF_DIR }}/$filename.pdf"

            pandoc "$md_file" \
              -o "$pdf_file" \
              --pdf-engine=xelatex \
              --template=templates/custom-template.tex \
              -V mainfont="WenQuanYi Micro Hei" \
              -V sansfont="WenQuanYi Micro Hei" \
              -V monofont="WenQuanYi Micro Hei Mono" \
              -V geometry:margin=0.5in \
              -V geometry:paper=a4paper \
              -V colorlinks=true \
              -V linkcolor=blue \
              -V urlcolor=blue \
              -V toccolor=blue \
              -V fontsize=12pt \
              -V linestretch=1.2 \
              -M date="$(date +'%Y年%m月%d日')" \
              -M author="自动生成" \
              --toc \
              --toc-depth=3 \
              -N \
              --wrap=preserve

            echo "Generated: $pdf_file"
          fi
        done

    - name: Convert all MD files (manual trigger)
      if: github.event_name == 'workflow_dispatch'
      run: |
        find ${{ env.MD_DIR }} -name "*.md" | while read md_file; do
          echo "Converting: $md_file"
          filename=$(basename "$md_file" .md)
          pdf_file="${{ env.PDF_DIR }}/$filename.pdf"

          pandoc "$md_file" \
            -o "$pdf_file" \
            --pdf-engine=xelatex \
            --template=templates/custom-template.tex \
            -V mainfont="WenQuanYi Micro Hei" \
            -V sansfont="WenQuanYi Micro Hei" \
            -V monofont="WenQuanYi Micro Hei Mono" \
            -V geometry:margin=0.5in \
            -V geometry:paper=a4paper \
            -V colorlinks=true \
            -V linkcolor=blue \
            -V urlcolor=blue \
            -V toccolor=blue \
            -M date="$(date +'%Y年%m月%d日')" \
            -M author="自动生成" \
            --toc \
            --toc-depth=3 \
            -N
        done

    - name: Upload PDF artifacts
      uses: actions/upload-artifact@v4
      with:
        name: generated-pdfs
        path: ${{ env.PDF_DIR }}/*.pdf
        retention-days: 7

    - name: Commit and push PDF files
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        # 检查是否有 PDF 文件
        if ! ls ${{ env.PDF_DIR }}/*.pdf 1> /dev/null 2>&1; then
          echo "No PDF files found"
          exit 0
        fi

        git add ${{ env.PDF_DIR }}/*.pdf

        # 检查是否有文件需要提交
        if git diff --staged --quiet; then
          echo "No changes to commit"
          exit 0
        fi

        git commit -m "Auto-generated PDFs from Markdown [skip ci]"
        git pull --rebase
        git push