name: OCR

on:
  push:
    branches: [ main, master ]
    paths:
      - 'images/**'
  workflow_dispatch:
    inputs:
      process_all:
        description: 'Process all images'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write

jobs:
  ocr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: mkdir -p texts
      
      - name: Download and setup Umi-OCR
        run: |
          wget https://github.com/hiroi-sora/Umi-OCR/releases/download/v2.1.5/Umi-OCR_Linux_Paddle_2.1.5.tar.xz
          tar -xf Umi-OCR_Linux_Paddle_2.1.5.tar.xz
          
          # Configure to allow HTTP requests
          printf "\n[Global]\nserver.host=0.0.0.0\n" > Umi-OCR_Linux_Paddle_2.1.5/UmiOCR-data/.settings
          
          # Start Umi-OCR in background with virtual display
          export HEADLESS=true
          xvfb-run -a Umi-OCR_Linux_Paddle_2.1.5/umi-ocr.sh > /tmp/umi-ocr.log 2>&1 &
          UMI_PID=$!
          echo $UMI_PID > /tmp/umi-ocr.pid
          
          # Wait for Umi-OCR to start
          echo "Waiting for Umi-OCR to start..."
          for i in {1..120}; do
            if curl -s http://localhost:1224/api/ocr > /dev/null 2>&1; then
              echo "Umi-OCR is ready"
              break
            fi
            echo "Attempt $i: Umi-OCR not ready yet..."
            sleep 2
          done
          
          # Show log if failed to start
          if ! curl -s http://localhost:1224/api/ocr > /dev/null 2>&1; then
            echo "Umi-OCR failed to start. Log:"
            cat /tmp/umi-ocr.log
            exit 1
          fi
      
      - name: Process all images
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.process_all == 'true'
        run: |
          find images -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" -o -name "*.bmp" \) | while read img; do
            if [ -f "$img" ]; then
              filename=$(basename "$img" | sed 's/\.[^.]*$//')
              echo "Processing: $filename"
              
              # Use Python to process the image
              python3 << PYTHON_SCRIPT
import base64
import json
import subprocess
import sys

# Read and encode image
with open('$img', 'rb') as f:
    image_data = base64.b64encode(f.read()).decode('utf-8')

# Create request
request = {
    "base64": image_data,
    "options": {
        "tbpu.parser": "multi_para"
    }
}

# Save request to file
with open('/tmp/request.json', 'w', encoding='utf-8') as f:
    json.dump(request, f, ensure_ascii=False)

# Call API
result = subprocess.run([
    'curl', '-s', '-X', 'POST', 'http://localhost:1224/api/ocr',
    '-H', 'Content-Type: application/json',
    '-d', '@/tmp/request.json'
], capture_output=True, text=True)

# Parse response
try:
    response = json.loads(result.stdout)
    ocr_text = response.get('data', '')
except:
    ocr_text = ''

# Save result
with open('texts/${filename}.txt', 'w', encoding='utf-8') as f:
    f.write(ocr_text)

print(f"Saved: texts/${filename}.txt")
PYTHON_SCRIPT
            fi
          done
      
      - name: Process changed images
        if: github.event_name == 'push'
        run: |
          find images -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" -o -name "*.bmp" \) | while read img; do
            if [ -f "$img" ]; then
              filename=$(basename "$img" | sed 's/\.[^.]*$//')
              echo "Processing: $filename"
              
              # Use Python to process the image
              python3 << PYTHON_SCRIPT
import base64
import json
import subprocess
import sys

# Read and encode image
with open('$img', 'rb') as f:
    image_data = base64.b64encode(f.read()).decode('utf-8')

# Create request
request = {
    "base64": image_data,
    "options": {
        "tbpu.parser": "multi_para"
    }
}

# Save request to file
with open('/tmp/request.json', 'w', encoding='utf-8') as f:
    json.dump(request, f, ensure_ascii=False)

# Call API
result = subprocess.run([
    'curl', '-s', '-X', 'POST', 'http://localhost:1224/api/ocr',
    '-H', 'Content-Type: application/json',
    '-d', '@/tmp/request.json'
], capture_output=True, text=True)

# Parse response
try:
    response = json.loads(result.stdout)
    ocr_text = response.get('data', '')
except:
    ocr_text = ''

# Save result
with open('texts/${filename}.txt', 'w', encoding='utf-8') as f:
    f.write(ocr_text)

print(f"Saved: texts/${filename}.txt")
PYTHON_SCRIPT
            fi
          done
      
      - name: Stop Umi-OCR
        if: always()
        run: |
          if [ -f /tmp/umi-ocr.pid ]; then
            kill $(cat /tmp/umi-ocr.pid) 2>/dev/null || true
            rm /tmp/umi-ocr.pid
          fi
      
      - run: |
          git config user.email "bot@example.com"
          git config user.name "bot"
          git add texts/*.txt || true
          git diff --staged --quiet || git commit -m "Auto OCR [skip ci]" || true
          git pull --rebase || true
          git push || true